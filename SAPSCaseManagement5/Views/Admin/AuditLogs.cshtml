@model List<SAPSCaseManagement5.Models.AuditLog>

<h2 class="mt-4 mb-3">Audit Logs</h2>

<!-- Search Input -->
<div class="row mb-3">
    <div class="col-md-4">
        <input type="text" id="searchInput" placeholder="Search by action or user" class="form-control" onkeyup="searchTable()" />
    </div>
    <div class="col-md-4">
        <!-- Date range filter -->
        <input type="text" id="dateRange" class="form-control" placeholder="Select date range" />
    </div>
</div>

<!-- Table -->
<div class="table-responsive">
    <table class="table table-striped table-hover">
        <thead class="thead-dark">
            <tr>
                <th>Action</th>
                <th>User</th>
                <th>Timestamp</th>
                <th>Details</th>
            </tr>
        </thead>
        <tbody id="auditLogTableBody">
            @if (Model != null && Model.Count > 0)
            {
                foreach (var log in Model)
                {
                    <tr>
                        <td>@log.Action</td>
                        <td>@log.User</td>
                        <td>@log.Timestamp.ToLocalTime().ToString("yyyy-MM-dd HH:mm:ss")</td>
                        <td>@log.Details</td>
                    </tr>
                }
            }
            else
            {
                <tr>
                    <td colspan="4" class="text-center">No audit logs available.</td>
                </tr>
            }
        </tbody>
    </table>
</div>

<!-- Pagination -->
<nav aria-label="Audit log pagination">
    <ul class="pagination justify-content-center" id="pagination">
        <!-- Pagination items will be dynamically added here -->
    </ul>
</nav>

@section Scripts {
    <!-- Include Date Range Picker library -->
    <script src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css" />

    <script>
        // Search function for the table
        function searchTable() {
            var input = document.getElementById("searchInput");
            var filter = input.value.toLowerCase();
            var tableBody = document.getElementById("auditLogTableBody");
            var tr = tableBody.getElementsByTagName("tr");

            for (var i = 0; i < tr.length; i++) {
                var tdAction = tr[i].getElementsByTagName("td")[0]; // Action column
                var tdUser = tr[i].getElementsByTagName("td")[1]; // User column
                if (tdAction && tdUser) {
                    var txtValueAction = tdAction.textContent || tdAction.innerText;
                    var txtValueUser = tdUser.textContent || tdUser.innerText;
                    tr[i].style.display = (txtValueAction.toLowerCase().indexOf(filter) > -1 ||
                                           txtValueUser.toLowerCase().indexOf(filter) > -1) ? "" : "none";
                }
            }
        }

        // Initialize the date range picker
        $(function() {
            $('#dateRange').daterangepicker({
                opens: 'left',
                autoUpdateInput: false
            }, function(start, end, label) {
                $('#dateRange').val(start.format('YYYY-MM-DD') + ' to ' + end.format('YYYY-MM-DD'));
                filterByDateRange(start, end);
            });
        });

        // Filter table rows by selected date range
        function filterByDateRange(start, end) {
            var tableBody = document.getElementById("auditLogTableBody");
            var tr = tableBody.getElementsByTagName("tr");

            for (var i = 0; i < tr.length; i++) {
                var tdTimestamp = tr[i].getElementsByTagName("td")[2]; // Timestamp column
                if (tdTimestamp) {
                    var txtValueTimestamp = new Date(tdTimestamp.textContent || tdTimestamp.innerText);
                    tr[i].style.display = (txtValueTimestamp >= start && txtValueTimestamp <= end) ? "" : "none";
                }
            }
        }

        // Implement pagination (Assuming 10 rows per page)
        var currentPage = 1;
        var rowsPerPage = 10;

        function displayPage(page) {
            var tableBody = document.getElementById("auditLogTableBody");
            var tr = tableBody.getElementsByTagName("tr");

            var start = (page - 1) * rowsPerPage;
            var end = start + rowsPerPage;

            for (var i = 0; i < tr.length; i++) {
                tr[i].style.display = (i >= start && i < end) ? "" : "none";
            }
        }

        function setupPagination() {
            var tableBody = document.getElementById("auditLogTableBody");
            var tr = tableBody.getElementsByTagName("tr");
            var totalRows = tr.length;
            var totalPages = Math.ceil(totalRows / rowsPerPage);

            var pagination = document.getElementById("pagination");
            pagination.innerHTML = ""; // Clear previous pagination

            for (var i = 1; i <= totalPages; i++) {
                var li = document.createElement("li");
                li.className = "page-item" + (i === currentPage ? " active" : "");
                li.innerHTML = '<a class="page-link" href="#" onclick="changePage(' + i + ')">' + i + '</a>';
                pagination.appendChild(li);
            }
        }

        function changePage(page) {
            currentPage = page;
            displayPage(page);
            setupPagination();
        }

        // Initial setup
        displayPage(currentPage);
        setupPagination();
    </script>
}

<a href="javascript:history.back()" class="btn btn-secondary">Return Back</a>